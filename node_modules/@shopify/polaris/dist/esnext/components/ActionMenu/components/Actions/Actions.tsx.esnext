import React$1, { useRef, useState, useCallback, useMemo, useEffect } from 'react';
import { useFeatures } from '../../../../utilities/features/hooks.tsx.esnext';
import debounce$1 from 'lodash/debounce';
import { EventListener as EventListener$1 } from '../../../EventListener/EventListener.tsx.esnext';
import { classNames } from '../../../../utilities/css.ts.esnext';
import { ButtonGroup as ButtonGroup$1 } from '../../../ButtonGroup/ButtonGroup.tsx.esnext';
import { sortAndOverrideActionOrder } from '../../utilities.ts.esnext';
import { MenuAction as MenuAction$1 } from '../MenuAction/MenuAction.tsx.esnext';
import { SecondaryAction as SecondaryAction$1 } from '../SecondaryAction/SecondaryAction.tsx.esnext';
import { MenuGroup as MenuGroup$1 } from '../MenuGroup/MenuGroup.tsx.esnext';
import styles from './Actions.scss.esnext';

const ACTION_SPACING = 4;
function Actions({
  actions = [],
  groups = []
}) {
  const {
    newDesignLanguage
  } = useFeatures();
  const actionsLayoutRef = useRef(null);
  const menuGroupRef = useRef(null);
  const menuGroupWidthRef = useRef(0);
  const [actionWidths, setActionWidths] = useState([]);
  const [availableWidth, setAvailableWidth] = useState(0);
  const [activeMenuGroup, setActiveMenuGroup] = useState(undefined);
  const [showableActions, setShowableActions] = useState(null);
  const [hiddenActions, setHiddenActions] = useState([]);
  const handleOffsetWidth = useCallback(width => setActionWidths(actionWidths => [...actionWidths, width]), []);
  const handleMenuGroupToggle = useCallback(group => setActiveMenuGroup(activeMenuGroup ? undefined : group), [activeMenuGroup]);
  const handleMenuGroupClose = useCallback(() => setActiveMenuGroup(undefined), []);
  const handleResize = useMemo(() => debounce$1(() => {
    if (!newDesignLanguage || !actionsLayoutRef.current) return;
    setAvailableWidth(actionsLayoutRef.current.offsetWidth);
  }, 20, {
    leading: false,
    trailing: true,
    maxWait: 40
  }), [newDesignLanguage]);
  useEffect(() => {
    if (!actionsLayoutRef.current) return;
    setAvailableWidth(actionsLayoutRef.current.offsetWidth);
  }, [actionsLayoutRef]);
  useEffect(() => {
    var _menuGroupRef$current;

    if (!menuGroupRef.current) return;
    menuGroupWidthRef.current = (_menuGroupRef$current = menuGroupRef.current) == null ? void 0 : _menuGroupRef$current.offsetWidth;
  }, [menuGroupRef]);
  useEffect(() => {
    if (!newDesignLanguage || actionWidths.length === 0 || availableWidth === 0) return;
    let currentAvailableWidth = availableWidth;
    setShowableActions([]);
    setHiddenActions([]);
    actions.forEach((action, index) => {
      if (actionWidths[index] + menuGroupWidthRef.current + ACTION_SPACING <= currentAvailableWidth) {
        currentAvailableWidth -= actionWidths[index];
        setShowableActions(showableActions => [...(showableActions || []), action]);
      } else {
        currentAvailableWidth = 0;
        setHiddenActions(hiddenActions => [...hiddenActions, action]);
      }
    });
  }, [actionWidths, actions, availableWidth, newDesignLanguage]);
  const className = classNames(styles.ActionsLayout, newDesignLanguage && styles.newDesignLanguage);
  const menuActions = [...actions, ...groups];
  const overriddenActions = sortAndOverrideActionOrder(menuActions);
  const actionMarkup = overriddenActions.map((action, index) => {
    if ('title' in action) {
      const {
        title,
        actions,
        ...rest
      } = action;
      return actions.length > 0 ? /*#__PURE__*/React$1.createElement("div", {
        key: `MenuGroup-${index}`,
        ref: menuGroupRef
      }, /*#__PURE__*/React$1.createElement(MenuGroup$1, Object.assign({
        title: title,
        active: title === activeMenuGroup,
        actions: [...hiddenActions, ...actions]
      }, rest, {
        onOpen: handleMenuGroupToggle,
        onClose: handleMenuGroupClose
      }))) : null;
    }

    if (showableActions && showableActions.length >= 0) return null;
    const {
      content,
      onAction,
      ...rest
    } = action;
    return newDesignLanguage ? /*#__PURE__*/React$1.createElement(SecondaryAction$1, Object.assign({
      key: index,
      onClick: onAction
    }, rest, {
      getOffsetWidth: handleOffsetWidth
    }), content) : /*#__PURE__*/React$1.createElement(MenuAction$1, Object.assign({
      key: `MenuAction-${index}`,
      content: content,
      onAction: onAction
    }, rest));
  });
  return /*#__PURE__*/React$1.createElement("div", {
    className: className,
    ref: actionsLayoutRef
  }, newDesignLanguage ? /*#__PURE__*/React$1.createElement(ButtonGroup$1, {
    spacing: "extraTight"
  }, showableActions && showableActions.length > 0 ? showableActions.map(action => /*#__PURE__*/React$1.createElement(SecondaryAction$1, Object.assign({
    key: action.content
  }, action, {
    getOffsetWidth: handleOffsetWidth
  }), action.content)) : null, actionMarkup) : actionMarkup, /*#__PURE__*/React$1.createElement(EventListener$1, {
    event: "resize",
    handler: handleResize
  }));
}

export { Actions };
